<html>
	<head>
		<meta charset="UTF-8"/>
		<meta name="pinterest" content="nopin"/>
    	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    	<meta name="viewport" content="width=device-width, initial-scale=1"/>
    	<meta name="description" content=""/>
    	<meta name="author" content=""/>
		<title>NFB Software: Sans-Server Application Example</title>
		<link href="static/css/style.css" rel="stylesheet" type="text/css"/>
		<script src="static/js/jquery.min.js"></script>
		<script src="static/js/aws-sdk.min.js"></script>
		<script src="generated/sans-server-config.js"></script>
		<script>
		  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
		
		  ga('create', 'UA-55354143-2', 'auto');
		  ga('send', 'pageview');
		</script>
	</head>
	<body>
  		<h1>SansServer SAP Web Application Example</h1>
  		<div id="info">Hellz Yeah</div>
	</body>
	<script>
		$(document).ready(function() 
		{
			AWS.config.region = sansServerConfig.region;
			AWS.config.credentials = new AWS.CognitoIdentityCredentials({
				IdentityPoolId: sansServerConfig.identityPoolId
			});
			
			indexPageObject = new function ()
			{
				var awsLambda;
				
				var userId;
				var identityId;
				var openIdToken;
				
				
				
				this.initPage = function()
				{
					indexPageObject.awsLambda = new AWS.Lambda();
					
					$("#loginButton").click(function(){
						indexPageObject.submitLoginForm();
					});
					
					$("#viewUserButton").click(function(){
						indexPageObject.viewUser();
					});
				}
				
				this.submitLoginForm = function()
				{
					$("#loginForm").hide();
					$("#progressPanel").show();
					
					var requestBody = {
							username: $("#username").val(),
							password: $("#password").val()
					};
					
					$.ajax(
					{
						url: sansServerConfig.baseServiceUrl + "/authenticate",
						data: JSON.stringify(requestBody),
						type: "POST",
						cache:false,
						dataType: "json",
						success: function (response) 
						{
							console.log(response);
							
							if(response.status == "SUCCESS")
							{
								indexPageObject.userId = response.data.authenticatedUser.userId;
								indexPageObject.identityId = response.data.authenticatedUser.identityId;
								indexPageObject.openIdToken = response.data.authenticatedUser.openIdToken;
								
								// Configure our AWS credentials	
								var creds = AWS.config.credentials;
								creds.params.IdentityId = indexPageObject.identityId;
								creds.params.Logins = {
									'cognito-identity.amazonaws.com': indexPageObject.openIdToken
								};
								creds.expired = true;
								
								// Hide the login page
								$("#progressPanel").hide();
								
								// Display the authenticated page
								$("#info").text("Welcome " + response.data.authenticatedUser.fullName);
								$("#viewUserForm").show();
							}
							else
							{
								$("#errorMessage").text(response.statusMessage);
								$("#errorPanel").show();
								
								$("#progressPanel").hide();
								$("#loginForm").show();
							}
		                },
		                error: function (data) 
		                {
		                	console.log(data);
		                }
					});
				}
				
				this.viewUser = function()
				{
					var requestBody = {
							userId: indexPageObject.userId
					};
					
					AWS.config.credentials.get(function(err)
					{
				    	if(err)
				    	{
				    		console.log(err, err.stack);
				    	}
				    	else
				    	{
							indexPageObject.awsLambda.invoke(
								{
									FunctionName: sansServerConfig.environmentPrefix + 'ViewUser',
					        		Payload: JSON.stringify(requestBody)
					        	},
					        	function(err, data)
					        	{
					        		if (err)
					        		{
					        			console.log(err, err.stack);
					        		}
					        		else
					        		{
					        			var output = JSON.parse(data.Payload);
					        			
					        			var fullName = output.data.user.fullName;
					        			alert("Welcome " + fullName);
					        		}
					        	}
					    	);
				    	}
				    });
				}
			}
			
			indexPageObject.initPage();
		});
	</script>
</html>